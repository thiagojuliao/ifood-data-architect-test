{"paragraphs":[{"text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Caminho de origem da raw order\norigem_raw = \"hdfs://localhost:9000/ifood-raw-order/\"\n\n# Caminho de destino da trusted items\ndestino_trusted = \"hdfs://localhost:9000/ifood-trusted-items/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-trusted-items-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima do tamanho das partições ao ler os arquivos de entrada\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições\nspark.conf.set(\"spark.default.parallelism\", 100) # Define a quantidade de tasks a serem executadas em paralelo","user":"anonymous","dateUpdated":"2019-12-25T13:18:16-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577290524893_-2103808596","id":"20191225-131524_1962480069","dateCreated":"2019-12-25T13:15:24-0300","dateStarted":"2019-12-25T13:18:16-0300","dateFinished":"2019-12-25T13:18:16-0300","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:172"},{"title":"Lê a base de origem","text":"%pyspark\n\n# Lê a raw order\nrawDF = spark.read.parquet(origem_raw).filter(col(\"dt\") == \"2019-01-01\").select(\"order_id\", \"items\", \"dt\")","user":"anonymous","dateUpdated":"2019-12-25T13:20:14-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577290696200_-1044201661","id":"20191225-131816_325476885","dateCreated":"2019-12-25T13:18:16-0300","dateStarted":"2019-12-25T13:20:14-0300","dateFinished":"2019-12-25T13:20:16-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:173"},{"text":"%pyspark\nrawDF.show(1, False)","user":"anonymous","dateUpdated":"2019-12-25T13:20:27-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\n|order_id                            |items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |dt        |\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[[COCA - COLA 2L, [0, BRL], [0, BRL], 1.0, 1, [900, BRL], f9fee383f6cd4cbb917f240ea37cd767, [900, BRL],, [],, [0, BRL], [0, BRL]], [Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]]|2019-01-01|\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\nonly showing top 1 row\n\n"}]},"apps":[],"jobName":"paragraph_1577290814796_-1379880617","id":"20191225-132014_1262569808","dateCreated":"2019-12-25T13:20:14-0300","dateStarted":"2019-12-25T13:20:27-0300","dateFinished":"2019-12-25T13:20:28-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:174"},{"title":"Explode o array items","text":"%pyspark\n\n# Explodindo a coluna items\nexpDF = rawDF \\\n    .withColumn(\"items\", explode_outer(\"items\"))\n\nexpDF.show(2, False)","user":"anonymous","dateUpdated":"2019-12-25T13:43:41-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\n|order_id                            |items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |dt        |\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[COCA - COLA 2L, [0, BRL], [0, BRL], 1.0, 1, [900, BRL], f9fee383f6cd4cbb917f240ea37cd767, [900, BRL],, [],, [0, BRL], [0, BRL]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|2019-01-01|\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+\nonly showing top 2 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577290827430_965368469","id":"20191225-132027_1992353080","dateCreated":"2019-12-25T13:20:27-0300","dateStarted":"2019-12-25T13:43:41-0300","dateFinished":"2019-12-25T13:43:42-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:175"},{"text":"%pyspark\n\nexpDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-25T13:45:16-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- order_id: string (nullable = true)\n |-- items: struct (nullable = true)\n |    |-- name: string (nullable = true)\n |    |-- addition: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |    |-- discount: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |    |-- quantity: double (nullable = true)\n |    |-- sequence: integer (nullable = true)\n |    |-- unitPrice: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |    |-- externalId: string (nullable = true)\n |    |-- totalValue: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |    |-- customerNote: string (nullable = true)\n |    |-- garnishItems: array (nullable = true)\n |    |    |-- element: struct (containsNull = true)\n |    |    |    |-- name: string (nullable = true)\n |    |    |    |-- addition: struct (nullable = true)\n |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |-- discount: struct (nullable = true)\n |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |-- quantity: double (nullable = true)\n |    |    |    |-- sequence: integer (nullable = true)\n |    |    |    |-- unitPrice: struct (nullable = true)\n |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |-- categoryId: string (nullable = true)\n |    |    |    |-- externalId: string (nullable = true)\n |    |    |    |-- totalValue: struct (nullable = true)\n |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |-- categoryName: string (nullable = true)\n |    |    |    |-- integrationId: string (nullable = true)\n |    |-- integrationId: string (nullable = true)\n |    |-- totalAddition: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |    |-- totalDiscount: struct (nullable = true)\n |    |    |-- value: string (nullable = true)\n |    |    |-- currency: string (nullable = true)\n |-- dt: date (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1577292307441_-1956643638","id":"20191225-134507_2093030615","dateCreated":"2019-12-25T13:45:07-0300","dateStarted":"2019-12-25T13:45:16-0300","dateFinished":"2019-12-25T13:45:16-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:176"},{"title":"Definimos um map para cada elemento do array afim de transformá-los em colunas para facilitar a leitura","text":"%pyspark\n\n# Cria o map de colunas para o array items\nmap_colunas = \\\n[\n    \"order_id\",\n    \"items\",\n    expr(\"items.name as item_name\"),\n    expr(\"items.addition.currency as item_currency\"),\n    expr(\"items.addition.value/100 as item_addition_value\"),\n    expr(\"items.discount.value/100 as item_discount_value\"),\n    expr(\"items.quantity as item_quantity\"),\n    expr(\"items.sequence as item_sequence\"),\n    expr(\"items.unitPrice.value/100 as item_unit_price\"),\n    expr(\"items.externalId as item_external_id\"),\n    expr(\"items.totalValue.value/100 as item_total_value\"),\n    expr(\"items.customerNote as item_customer_note\"),\n    expr(\"items.garnishItems as item_garnish_list\"),\n    expr(\"items.integrationId as item_integration_id\"),\n    expr(\"items.totalAddition.value/100 as item_total_addition_value\"),\n    expr(\"items.totalDiscount.value/100 as total_discount_value\"),\n    \"dt\"\n]\n\n# Aplica o map no dataframe\nmapDF = expDF.select(map_colunas)","user":"anonymous","dateUpdated":"2019-12-25T14:39:02-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577290955234_-1823548479","id":"20191225-132235_1630035315","dateCreated":"2019-12-25T13:22:35-0300","dateStarted":"2019-12-25T14:09:01-0300","dateFinished":"2019-12-25T14:09:01-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:177"},{"text":"%pyspark\n\nmapDF.select(map_colunas).show(2, False)","user":"anonymous","dateUpdated":"2019-12-25T14:09:08-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\n|order_id                            |items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |item_name                                |item_currency|item_addition_value|item_discount_value|item_quantity|item_sequence|item_unit_price|item_external_id                |item_total_value|item_customer_note|item_garnish_list                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |item_integration_id|item_total_addition_value|total_discount_value|dt        |\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[COCA - COLA 2L, [0, BRL], [0, BRL], 1.0, 1, [900, BRL], f9fee383f6cd4cbb917f240ea37cd767, [900, BRL],, [],, [0, BRL], [0, BRL]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |COCA - COLA 2L                           |BRL          |0.0                |0.0                |1.0          |1            |9.0            |f9fee383f6cd4cbb917f240ea37cd767|9.0             |null              |[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |null               |0.0                      |0.0                 |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |[[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]]|null               |0.0                      |0.0                 |2019-01-01|\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\nonly showing top 2 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577292291085_1558820133","id":"20191225-134451_783228144","dateCreated":"2019-12-25T13:44:51-0300","dateStarted":"2019-12-25T14:09:08-0300","dateFinished":"2019-12-25T14:09:09-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:178"},{"title":"Explodindo a coluna item_garnish_list e definindo um novo map para suas colunas","text":"%pyspark\n\n# Explode o array item_garnish_list\nexpDF_ = mapDF \\\n    .withColumn(\"item_garnish_list\", explode_outer(\"item_garnish_list\"))\n\nexpDF_.show(5, False)","user":"anonymous","dateUpdated":"2019-12-25T14:39:22-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\n|order_id                            |items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |item_name                                |item_currency|item_addition_value|item_discount_value|item_quantity|item_sequence|item_unit_price|item_external_id                |item_total_value|item_customer_note|item_garnish_list                                                                                                                                         |item_integration_id|item_total_addition_value|total_discount_value|dt        |\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[COCA - COLA 2L, [0, BRL], [0, BRL], 1.0, 1, [900, BRL], f9fee383f6cd4cbb917f240ea37cd767, [900, BRL],, [],, [0, BRL], [0, BRL]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |COCA - COLA 2L                           |BRL          |0.0                |0.0                |1.0          |1            |9.0            |f9fee383f6cd4cbb917f240ea37cd767|9.0             |null              |null                                                                                                                                                      |null               |0.0                      |0.0                 |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,]         |null               |0.0                      |0.0                 |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |[1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,]       |null               |0.0                      |0.0                 |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |[1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,]|null               |0.0                      |0.0                 |2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|[Promoção Duas Pizzas Grande por R$50,00.*, [0, BRL], [0, BRL], 1.0, 2, [5000, BRL], 237bc89f663c4913b370c83e9f195977, [5000, BRL],, [[1/2 toscana, [0, BRL], [0, BRL], 1.0, 3, [0, BRL], 12HOC, abf55039a2324a3aa68c77b7fea61c37, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 calabreza, [0, BRL], [0, BRL], 1.0, 4, [0, BRL], 12HOC, 760ee7c29ce74d15ab99b7d7c57b1029, [0, BRL], Escolha a sua primeira pizza meio a meio,], [1/2 frango com catupiry, [0, BRL], [0, BRL], 1.0, 5, [0, BRL], 12HOD, 1bbddcf837334188b2f88d9ce0a9bc02, [0, BRL], Escolha sua segunda pizza Meio a Meio,], [1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]],, [0, BRL], [0, BRL]]|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |[1/2 portuguesa, [0, BRL], [0, BRL], 1.0, 6, [0, BRL], 12HOD, 8b01a10763c34bc2a0a0fe712d20daf0, [0, BRL], Escolha sua segunda pizza Meio a Meio,]         |null               |0.0                      |0.0                 |2019-01-01|\n+------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+-------------------------+--------------------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577293106841_-538724422","id":"20191225-135826_1333122364","dateCreated":"2019-12-25T13:58:26-0300","dateStarted":"2019-12-25T14:13:20-0300","dateFinished":"2019-12-25T14:13:20-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:179"},{"text":"%pyspark\n\n# Cria e aplica o novo map\nmap_colunas_ = \\\n[\n    \"order_id\",\n    \"item_name\",\n    \"item_currency\",\n    \"item_addition_value\",\n    \"item_discount_value\",\n    \"item_quantity\",\n    \"item_sequence\",\n    \"item_unit_price\",\n    \"item_external_id\",\n    \"item_total_value\",\n    \"item_customer_note\",\n    expr(\"item_garnish_list.name as garnish_name\"),\n    expr(\"item_garnish_list.addition.value/100 as garnish_addition_value\"),\n    expr(\"item_garnish_list.discount.value/100 as garnish_discount_value\"),\n    expr(\"item_garnish_list.quantity as garnish_quantity\"),\n    expr(\"item_garnish_list.sequence as garnish_sequence\"),\n    expr(\"item_garnish_list.unitPrice.value/100 as garnish_unit_price\"),\n    expr(\"item_garnish_list.categoryId as garnish_category_id\"),\n    expr(\"item_garnish_list.externalId as garnish_external_id\"),\n    expr(\"item_garnish_list.totalValue.value/100 as garnish_total_value\"),\n    expr(\"item_garnish_list.categoryName as garnish_category_name\"),\n    expr(\"item_garnish_list.integrationId as garnish_integration_id\"),\n    \"item_integration_id\",\n    \"item_total_addition_value\",\n    \"total_discount_value\",\n    expr(\"current_date as dt_proc\"),\n    \"dt\"\n]\n\nmapDF_ = expDF_.select(map_colunas_)","user":"anonymous","dateUpdated":"2019-12-25T14:29:47-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577293959832_-1775018827","id":"20191225-141239_171984061","dateCreated":"2019-12-25T14:12:39-0300","dateStarted":"2019-12-25T14:29:47-0300","dateFinished":"2019-12-25T14:29:47-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:180"},{"text":"%pyspark\n\nmapDF_.show(5, False)","user":"anonymous","dateUpdated":"2019-12-25T14:29:51-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------+----------------------+----------------------+----------------+----------------+------------------+-------------------+--------------------------------+-------------------+----------------------------------------+----------------------+-------------------+-------------------------+--------------------+----------+----------+\n|order_id                            |item_name                                |item_currency|item_addition_value|item_discount_value|item_quantity|item_sequence|item_unit_price|item_external_id                |item_total_value|item_customer_note|garnish_name           |garnish_addition_value|garnish_discount_value|garnish_quantity|garnish_sequence|garnish_unit_price|garnish_category_id|garnish_external_id             |garnish_total_value|garnish_category_name                   |garnish_integration_id|item_integration_id|item_total_addition_value|total_discount_value|dt_proc   |dt        |\n+------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------+----------------------+----------------------+----------------+----------------+------------------+-------------------+--------------------------------+-------------------+----------------------------------------+----------------------+-------------------+-------------------------+--------------------+----------+----------+\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|COCA - COLA 2L                           |BRL          |0.0                |0.0                |1.0          |1            |9.0            |f9fee383f6cd4cbb917f240ea37cd767|9.0             |null              |null                   |null                  |null                  |null            |null            |null              |null               |null                            |null               |null                                    |null                  |null               |0.0                      |0.0                 |2019-12-25|2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |1/2 toscana            |0.0                   |0.0                   |1.0             |3               |0.0               |12HOC              |abf55039a2324a3aa68c77b7fea61c37|0.0                |Escolha a sua primeira pizza meio a meio|null                  |null               |0.0                      |0.0                 |2019-12-25|2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |1/2 calabreza          |0.0                   |0.0                   |1.0             |4               |0.0               |12HOC              |760ee7c29ce74d15ab99b7d7c57b1029|0.0                |Escolha a sua primeira pizza meio a meio|null                  |null               |0.0                      |0.0                 |2019-12-25|2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |1/2 frango com catupiry|0.0                   |0.0                   |1.0             |5               |0.0               |12HOD              |1bbddcf837334188b2f88d9ce0a9bc02|0.0                |Escolha sua segunda pizza Meio a Meio   |null                  |null               |0.0                      |0.0                 |2019-12-25|2019-01-01|\n|cf99f3ce-f47b-4a56-8e68-52c9be6ed167|Promoção Duas Pizzas Grande por R$50,00.*|BRL          |0.0                |0.0                |1.0          |2            |50.0           |237bc89f663c4913b370c83e9f195977|50.0            |null              |1/2 portuguesa         |0.0                   |0.0                   |1.0             |6               |0.0               |12HOD              |8b01a10763c34bc2a0a0fe712d20daf0|0.0                |Escolha sua segunda pizza Meio a Meio   |null                  |null               |0.0                      |0.0                 |2019-12-25|2019-01-01|\n+------------------------------------+-----------------------------------------+-------------+-------------------+-------------------+-------------+-------------+---------------+--------------------------------+----------------+------------------+-----------------------+----------------------+----------------------+----------------+----------------+------------------+-------------------+--------------------------------+-------------------+----------------------------------------+----------------------+-------------------+-------------------------+--------------------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577294187852_-142468547","id":"20191225-141627_1489538231","dateCreated":"2019-12-25T14:16:27-0300","dateStarted":"2019-12-25T14:29:52-0300","dateFinished":"2019-12-25T14:29:52-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:181"},{"text":"%pyspark\n\nmapDF_.printSchema()","user":"anonymous","dateUpdated":"2019-12-25T14:32:51-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- order_id: string (nullable = true)\n |-- item_name: string (nullable = true)\n |-- item_currency: string (nullable = true)\n |-- item_addition_value: double (nullable = true)\n |-- item_discount_value: double (nullable = true)\n |-- item_quantity: double (nullable = true)\n |-- item_sequence: integer (nullable = true)\n |-- item_unit_price: double (nullable = true)\n |-- item_external_id: string (nullable = true)\n |-- item_total_value: double (nullable = true)\n |-- item_customer_note: string (nullable = true)\n |-- garnish_name: string (nullable = true)\n |-- garnish_addition_value: double (nullable = true)\n |-- garnish_discount_value: double (nullable = true)\n |-- garnish_quantity: double (nullable = true)\n |-- garnish_sequence: integer (nullable = true)\n |-- garnish_unit_price: double (nullable = true)\n |-- garnish_category_id: string (nullable = true)\n |-- garnish_external_id: string (nullable = true)\n |-- garnish_total_value: double (nullable = true)\n |-- garnish_category_name: string (nullable = true)\n |-- garnish_integration_id: string (nullable = true)\n |-- item_integration_id: string (nullable = true)\n |-- item_total_addition_value: double (nullable = true)\n |-- total_discount_value: double (nullable = true)\n |-- dt_proc: date (nullable = false)\n |-- dt: date (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1577295162872_-2035940713","id":"20191225-143242_988327290","dateCreated":"2019-12-25T14:32:42-0300","dateStarted":"2019-12-25T14:32:51-0300","dateFinished":"2019-12-25T14:32:51-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:182"},{"title":"Grava a base trusted items","text":"%pyspark\n\nmapDF_ \\\n    .repartition(int(spark.conf.get(\"spark.default.parallelism\")), \"dt\") \\\n    .write.mode(\"overwrite\") \\\n    .partitionBy(\"dt\") \\\n    .option(\"compression\", \"snappy\") \\\n    .format(\"parquet\") \\\n    .save(destino_trusted)","user":"anonymous","dateUpdated":"2019-12-25T14:40:23-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577294645968_1515254618","id":"20191225-142405_150913814","dateCreated":"2019-12-25T14:24:05-0300","dateStarted":"2019-12-25T14:32:31-0300","dateFinished":"2019-12-25T14:32:41-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:183"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-25T14:32:30-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577295150961_-1689579037","id":"20191225-143230_1348839517","dateCreated":"2019-12-25T14:32:30-0300","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:184"}],"name":"ifood-trusted-items-dev","id":"2EY83J7TA","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}