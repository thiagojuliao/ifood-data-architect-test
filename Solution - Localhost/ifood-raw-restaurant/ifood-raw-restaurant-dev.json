{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Caminho de origem da pouso restaurant\norigem_pouso = \"hdfs://localhost:9000/ifood-landing-restaurant/full-load/restaurant.csv.gz\"\n\n# Caminho de destino da raw restaurant\ndestino_raw = \"hdfs://localhost:9000/ifood-raw-restaurant/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-raw-restaurant-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-24T18:05:55-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577221300881_2100809792","id":"20191221-124444_835401478","dateCreated":"2019-12-24T18:01:40-0300","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:6695","dateFinished":"2019-12-24T18:03:18-0300","dateStarted":"2019-12-24T18:03:18-0300"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.option(\"header\", True).csv(origem_pouso)","user":"anonymous","dateUpdated":"2019-12-24T18:03:23-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577221300897_49080937","id":"20191221-124622_2019804708","dateCreated":"2019-12-24T18:01:40-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:6696","dateFinished":"2019-12-24T18:03:24-0300","dateStarted":"2019-12-24T18:03:23-0300"},{"text":"%pyspark\n\npousoDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-24T18:03:28-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- id: string (nullable = true)\n |-- created_at: string (nullable = true)\n |-- enabled: string (nullable = true)\n |-- price_range: string (nullable = true)\n |-- average_ticket: string (nullable = true)\n |-- takeout_time: string (nullable = true)\n |-- delivery_time: string (nullable = true)\n |-- minimum_order_value: string (nullable = true)\n |-- merchant_zip_code: string (nullable = true)\n |-- merchant_city: string (nullable = true)\n |-- merchant_state: string (nullable = true)\n |-- merchant_country: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1577221300897_-281497852","id":"20191221-124723_98133630","dateCreated":"2019-12-24T18:01:40-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:6697","dateFinished":"2019-12-24T18:03:28-0300","dateStarted":"2019-12-24T18:03:28-0300"},{"text":"%pyspark\n\npousoDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:03:35-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\n|id                                  |created_at              |enabled|price_range|average_ticket|takeout_time|delivery_time|minimum_order_value|merchant_zip_code|merchant_city |merchant_state|merchant_country|\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\n|02c94103-61f3-4906-a4a9-55611db9f28c|2017-01-23T12:52:30.910Z|false  |3          |60.0          |0           |50           |30.0               |14025            |RIBEIRAO PRETO|SP            |BR              |\n|15e7f5fd-090d-47b9-9f14-b6f7fce3c95d|2017-01-20T13:14:48.286Z|true   |3          |60.0          |0           |0            |30.0               |50180            |SAO PAULO     |SP            |BR              |\n|33ca5d3d-b99f-404d-84d9-8df8f38a2261|2017-01-23T12:46:33.457Z|true   |5          |100.0         |0           |45           |10.0               |23090            |RIO DE JANEIRO|RJ            |BR              |\n|4927035f-a343-4a65-a9be-945818e2efff|2017-01-20T13:15:04.806Z|true   |3          |80.0          |0           |0            |18.9               |40255            |SALVADOR      |BA            |BR              |\n|52feaad8-4961-4afc-8d60-3f29ffd0a7a7|2017-01-20T13:14:27.701Z|true   |3          |60.0          |0           |0            |25.0               |64600            |BARUERI       |SP            |BR              |\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221300897_307886739","id":"20191221-124732_945883820","dateCreated":"2019-12-24T18:01:40-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:6698","dateFinished":"2019-12-24T18:03:38-0300","dateStarted":"2019-12-24T18:03:35-0300"},{"text":"%pyspark\n\n# Verificação de duplicidade na(s) chave(s)\npousoDF.groupBy(\"id\").agg(count(\"*\").alias(\"dup\")).filter(col(\"dup\") > 1).show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:01:40-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---+---+\n|id |dup|\n+---+---+\n+---+---+\n\n"}]},"apps":[],"jobName":"paragraph_1577221300912_-1493931746","id":"20191221-124745_36091137","dateCreated":"2019-12-24T18:01:40-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6699"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .withColumn(\"dt\", current_date())\n\nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-24T18:04:03-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577221300912_-83355284","id":"20191221-124855_1400670421","dateCreated":"2019-12-24T18:01:40-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:6702","dateFinished":"2019-12-24T18:04:06-0300","dateStarted":"2019-12-24T18:04:03-0300"},{"text":"%pyspark\n\nrawDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:01:40-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\n|id                                  |created_at              |enabled|price_range|average_ticket|takeout_time|delivery_time|minimum_order_value|merchant_zip_code|merchant_city |merchant_state|merchant_country|dt_proc   |dt        |\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\n|02c94103-61f3-4906-a4a9-55611db9f28c|2017-01-23T12:52:30.910Z|false  |3          |60.0          |0           |50           |30.0               |14025            |RIBEIRAO PRETO|SP            |BR              |2019-12-21|2017-01-23|\n|15e7f5fd-090d-47b9-9f14-b6f7fce3c95d|2017-01-20T13:14:48.286Z|true   |3          |60.0          |0           |0            |30.0               |50180            |SAO PAULO     |SP            |BR              |2019-12-21|2017-01-20|\n|33ca5d3d-b99f-404d-84d9-8df8f38a2261|2017-01-23T12:46:33.457Z|true   |5          |100.0         |0           |45           |10.0               |23090            |RIO DE JANEIRO|RJ            |BR              |2019-12-21|2017-01-23|\n|4927035f-a343-4a65-a9be-945818e2efff|2017-01-20T13:15:04.806Z|true   |3          |80.0          |0           |0            |18.9               |40255            |SALVADOR      |BA            |BR              |2019-12-21|2017-01-20|\n|52feaad8-4961-4afc-8d60-3f29ffd0a7a7|2017-01-20T13:14:27.701Z|true   |3          |60.0          |0           |0            |25.0               |64600            |BARUERI       |SP            |BR              |2019-12-21|2017-01-20|\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221300928_160823518","id":"20191221-125227_830449066","dateCreated":"2019-12-24T18:01:40-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6703"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw + \"/*/*.parquet\")\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\ncolunas = pousoDF.columns\ncolunas_ = rawDF_.drop(\"dt_proc\").columns\ncolunas.sort()\ncolunas_.sort()\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_ or colunas == colunas_))","user":"anonymous","dateUpdated":"2019-12-24T18:01:40-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> True\n> O schema de saída equivale-se ao de entrada ? ---> True\n"}]},"apps":[],"jobName":"paragraph_1577221300928_1384878001","id":"20191221-125122_890996710","dateCreated":"2019-12-24T18:01:40-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6704"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-24T18:01:40-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577221300928_2088959124","id":"20191221-125336_502681573","dateCreated":"2019-12-24T18:01:40-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6705"}],"name":"ifood-raw-restaurant-dev","id":"2EWH3GQHN","noteParams":{},"noteForms":{},"angularObjects":{"python:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}