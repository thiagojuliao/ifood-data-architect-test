{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Definição do schema json\nschema = StructType(\n    [\n        StructField(\"created_at\", StringType()),\n        StructField(\"order_id\", StringType()),\n        StructField(\"status_id\", StringType()),\n        StructField(\"value\", StringType())\n    ])\n    \n# Referência de processamento\n#ref00 = str(datetime.today() - timedelta(days=2))[0:10]\n#ref01 = str(datetime.today() - timedelta(days=1))[0:10] \nref00 = \"2019-01-31\"\nref01 = \"2019-01-30\"\n\n# Caminho de origem da pouso order-status\norigem_pouso = [\"s3://ifood-landing-order-status/dt={}\".format(ref00), \"s3://ifood-landing-order-status/dt={}\".format(ref01)]\n\n# Caminho de destino da raw order\ndestino_raw = \"s3://ifood-raw-order-status/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-raw-order-status-prod\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-23T13:42:04+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577107989471_1486576997","id":"20191221-124444_835401478","dateCreated":"2019-12-23T13:33:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:679","dateFinished":"2019-12-23T13:42:04+0000","dateStarted":"2019-12-23T13:42:04+0000"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.schema(schema).json(origem_pouso)","user":"anonymous","dateUpdated":"2019-12-23T13:42:06+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577107989471_-179122165","id":"20191221-124622_2019804708","dateCreated":"2019-12-23T13:33:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:680","dateFinished":"2019-12-23T13:42:07+0000","dateStarted":"2019-12-23T13:42:06+0000"},{"title":"Criando uma partição atráves da data de registro do pedido","text":"%pyspark\n\n# Adiciona a coluna dt que definirá nossa partição\npousoDF = pousoDF \\\n    .withColumn(\"dt\", expr(\"min(created_at) over(partition by order_id order by order_id)\")) \\\n    .withColumn(\"dt\", col(\"dt\").cast(DateType()))","user":"anonymous","dateUpdated":"2019-12-23T13:44:22+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577107989471_-838814854","id":"20191223-030021_460147328","dateCreated":"2019-12-23T13:33:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:681","dateFinished":"2019-12-23T13:44:22+0000","dateStarted":"2019-12-23T13:44:22+0000"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .dropDuplicates()\n    \nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-23T13:44:27+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577107989472_772467424","id":"20191221-124855_1400670421","dateCreated":"2019-12-23T13:33:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:682","dateFinished":"2019-12-23T13:44:44+0000","dateStarted":"2019-12-23T13:44:27+0000"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw).filter(col(\"dt\") == lit(ref))\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.dropDuplicates().count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\ncolunas = pousoDF.columns\ncolunas_ = rawDF_.drop(\"dt_proc\").columns\ncolunas.sort()\ncolunas_.sort()\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_ or colunas == colunas_))","user":"anonymous","dateUpdated":"2019-12-23T13:33:09+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> False\n> O schema de saída equivale-se ao de entrada ? ---> True\n"}]},"apps":[],"jobName":"paragraph_1577107989472_372425137","id":"20191221-125122_890996710","dateCreated":"2019-12-23T13:33:09+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:683"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-23T13:33:09+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577107989472_665986936","id":"20191221-172907_1085978558","dateCreated":"2019-12-23T13:33:09+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:684"}],"name":"ifood-raw-order-status-prod","id":"2EVAHJHAN","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}