{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Definição do schema json\nschema = StructType(\n    [\n        StructField(\"created_at\", StringType()),\n        StructField(\"order_id\", StringType()),\n        StructField(\"status_id\", StringType()),\n        StructField(\"value\", StringType())\n    ])\n    \n# Caminho de origem da pouso order-status\norigem_pouso = \"hdfs://localhost:9000/ifood-landing-order-status/full-load/status.json.gz\"\n\n# Caminho de destino da raw order\ndestino_raw = \"hdfs://localhost:9000/ifood-raw-order-status/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-raw-order-status-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-24T18:13:15-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577221716840_-475665895","id":"20191221-124444_835401478","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:7955","dateFinished":"2019-12-24T18:13:15-0300","dateStarted":"2019-12-24T18:13:15-0300"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.schema(schema).json(origem_pouso).persist(StorageLevel.DISK_ONLY)\nprint(\"> Volumetria da pouso orders: {}\".format(pousoDF.count()))","user":"anonymous","dateUpdated":"2019-12-24T18:13:22-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria da pouso orders: 11075048\n"}]},"apps":[],"jobName":"paragraph_1577221716841_-211997972","id":"20191221-124622_2019804708","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:7956","dateFinished":"2019-12-24T18:15:22-0300","dateStarted":"2019-12-24T18:13:22-0300"},{"text":"%pyspark\n\npousoDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-24T18:15:27-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- created_at: string (nullable = true)\n |-- order_id: string (nullable = true)\n |-- status_id: string (nullable = true)\n |-- value: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1577221716842_484464724","id":"20191221-124723_98133630","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:7957","dateFinished":"2019-12-24T18:15:27-0300","dateStarted":"2019-12-24T18:15:27-0300"},{"text":"%pyspark\n\npousoDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:15:31-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+\n|created_at              |order_id                            |status_id                           |value     |\n+------------------------+------------------------------------+------------------------------------+----------+\n|2019-01-25T01:05:07.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|b4298862-fa38-499a-93e2-a76930fb2bce|CONCLUDED |\n|2019-01-24T23:04:27.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|7964bf63-007a-484d-a321-e9118ccc2f97|REGISTERED|\n|2019-01-24T23:04:28.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|ca16b92b-db8f-4274-b165-929675541a9f|PLACED    |\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |\n+------------------------+------------------------------------+------------------------------------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221716843_-549796755","id":"20191221-124732_945883820","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:7958","dateFinished":"2019-12-24T18:15:32-0300","dateStarted":"2019-12-24T18:15:31-0300"},{"text":"%pyspark\n\n# Domínio da coluna value\npousoDF.select(\"value\").dropDuplicates().show(20, False)","user":"anonymous","dateUpdated":"2019-12-24T18:08:36-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+\n|value     |\n+----------+\n|CONCLUDED |\n|REGISTERED|\n|CANCELLED |\n|PLACED    |\n+----------+\n\n"}]},"apps":[],"jobName":"paragraph_1577221716844_360853905","id":"20191221-141757_50170210","dateCreated":"2019-12-24T18:08:36-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:7959"},{"text":"%pyspark\n\n# Verificação de duplicidade na(s) chave(s)\n# Possuímos duplicidade na(s) chave(s) logo devemos verificar!\npousoDF.groupBy(\"order_id\", \"status_id\", \"value\").agg(count(\"*\").alias(\"dup\")).filter(col(\"dup\") > 1).show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:08:36-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------------------+----------+---+\n|order_id                            |status_id                           |value     |dup|\n+------------------------------------+------------------------------------+----------+---+\n|021fc1cd-4812-443a-9e0c-d988923e72e1|a3e318a7-fd42-4d8e-8c1c-9c8aee92ab59|REGISTERED|2  |\n|02ef87b3-8ee3-4234-a914-1721ad32be20|fde7110c-1560-48eb-98dc-e241a4c22b48|REGISTERED|2  |\n|07f62f89-3590-4c9a-affb-bacc0f682eb5|2d5f468b-f52a-492f-926d-05be53cf1bfc|REGISTERED|2  |\n|0f7e443d-8ec7-46b6-bf79-9eb8411d03a0|6433b468-80c0-4277-bc94-1f9eac8496c7|PLACED    |2  |\n|0f93305d-7363-4b9c-941e-8dbff6de61f4|3be8a247-561a-47c9-815b-af9fd6469b7c|REGISTERED|2  |\n+------------------------------------+------------------------------------+----------+---+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221716846_-930381034","id":"20191221-124745_36091137","dateCreated":"2019-12-24T18:08:36-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:7960"},{"title":"Criando uma partição atráves da data de registro do pedido","text":"%pyspark\n\n# Adiciona a coluna dt que definirá nossa partição\npousoDF = pousoDF \\\n    .withColumn(\"dt\", expr(\"min(created_at) over(partition by order_id order by order_id)\")) \\\n    .withColumn(\"dt\", col(\"dt\").cast(DateType()))\n\npousoDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:17:52-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+----------+\n|created_at              |order_id                            |status_id                           |value     |dt        |\n+------------------------+------------------------------------+------------------------------------+----------+----------+\n|2019-01-25T01:05:07.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|b4298862-fa38-499a-93e2-a76930fb2bce|CONCLUDED |2019-01-24|\n|2019-01-24T23:04:27.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|7964bf63-007a-484d-a321-e9118ccc2f97|REGISTERED|2019-01-24|\n|2019-01-24T23:04:28.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|ca16b92b-db8f-4274-b165-929675541a9f|PLACED    |2019-01-24|\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |2019-01-17|\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |2019-01-17|\n+------------------------+------------------------------------+------------------------------------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221716847_-377732259","id":"20191223-024709_351894475","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:7961","dateFinished":"2019-12-24T18:19:02-0300","dateStarted":"2019-12-24T18:17:52-0300"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .dropDuplicates()\n    \nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-24T18:49:41-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577221716851_695100615","id":"20191221-124855_1400670421","dateCreated":"2019-12-24T18:08:36-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:7964","dateFinished":"2019-12-24T19:04:29-0300","dateStarted":"2019-12-24T18:49:41-0300"},{"text":"%pyspark\n\nrawDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T18:08:36-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|created_at              |order_id                            |status_id                           |value     |dt        |dt_proc   |\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|2019-01-25T01:05:07.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|b4298862-fa38-499a-93e2-a76930fb2bce|CONCLUDED |2019-01-24|2019-12-23|\n|2019-01-24T23:04:27.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|7964bf63-007a-484d-a321-e9118ccc2f97|REGISTERED|2019-01-24|2019-12-23|\n|2019-01-24T23:04:28.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|ca16b92b-db8f-4274-b165-929675541a9f|PLACED    |2019-01-24|2019-12-23|\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |2019-01-17|2019-12-23|\n|2019-01-17T22:42:18.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|6edee034-b55b-407a-b114-eb9a475ae52a|PLACED    |2019-01-17|2019-12-23|\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577221716857_862440449","id":"20191221-125227_830449066","dateCreated":"2019-12-24T18:08:36-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:7965"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw + \"/*/*.parquet\")\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.dropDuplicates().count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\ncolunas = pousoDF.columns\ncolunas_ = rawDF_.drop(\"dt_proc\").columns\ncolunas.sort()\ncolunas_.sort()\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_ or colunas == colunas_))","user":"anonymous","dateUpdated":"2019-12-24T18:08:36-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> False\n> O schema de saída equivale-se ao de entrada ? ---> True\n"}]},"apps":[],"jobName":"paragraph_1577221716887_-1755087049","id":"20191221-125122_890996710","dateCreated":"2019-12-24T18:08:36-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:7966"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-24T18:08:36-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577221716890_2031334151","id":"20191223-030616_1415664295","dateCreated":"2019-12-24T18:08:36-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:7967"}],"name":"ifood-raw-order-status-dev","id":"2EUYANVVJ","noteParams":{},"noteForms":{},"angularObjects":{"python:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}