{"paragraphs":[{"text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Caminho de origem da raw order status\norigem_raw = \"s3://ifood-raw-order-status/\"\n\n# Caminho de destino da trusted order status\ndestino_trusted = \"s3://ifood-trusted-order-status/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-trusted-order-status-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições","user":"anonymous","dateUpdated":"2019-12-23T04:38:49+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577064390848_887320418","id":"20191223-012630_1390010523","dateCreated":"2019-12-23T01:26:30+0000","dateStarted":"2019-12-23T04:38:49+0000","dateFinished":"2019-12-23T04:38:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:162","results":{"code":"SUCCESS","msg":[]}},{"title":"Lê a origem","text":"%pyspark\n\n# Lê a base raw order status\nrawDF = spark.read.parquet(origem_raw).filter(col(\"dt\") < \"2019-01-31\")\nrawDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-23T04:38:49+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"title":true,"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|created_at              |order_id                            |status_id                           |value     |dt_proc   |dt        |\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|2019-01-29T06:25:06.000Z|0115a7f2-be83-4265-9310-390e1f6e9391|0dd973d0-699c-4f85-84eb-452c9663cd03|CONCLUDED |2019-12-23|2019-01-29|\n|2019-01-29T04:25:00.000Z|0115a7f2-be83-4265-9310-390e1f6e9391|433e73d7-038c-4972-9465-1ae4e5eefdc8|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29T04:25:01.000Z|0115a7f2-be83-4265-9310-390e1f6e9391|bf1ff246-e7cb-45b7-9313-183aca486807|PLACED    |2019-12-23|2019-01-29|\n|2019-01-29T15:07:55.000Z|019c3f5a-8eac-4a14-a3f3-ebdfeb41f81e|527ecc08-61a1-4465-ae84-0a437382f2df|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29T17:10:10.000Z|019c3f5a-8eac-4a14-a3f3-ebdfeb41f81e|ed9c0e40-5347-4679-b4be-625cd38cb486|CONCLUDED |2019-12-23|2019-01-29|\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577064538874_-301948001","id":"20191223-012858_808752653","dateCreated":"2019-12-23T01:28:58+0000","dateStarted":"2019-12-23T04:38:49+0000","dateFinished":"2019-12-23T04:38:53+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:163"},{"text":"%pyspark\n\n# Domínio da coluna value\nrawDF.select(\"value\").dropDuplicates().show(20, False)","user":"anonymous","dateUpdated":"2019-12-23T04:38:53+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+\n|value     |\n+----------+\n|CONCLUDED |\n|REGISTERED|\n|CANCELLED |\n|PLACED    |\n+----------+\n\n"}]},"apps":[],"jobName":"paragraph_1577065005491_-1872220835","id":"20191223-013645_111599159","dateCreated":"2019-12-23T01:36:45+0000","dateStarted":"2019-12-23T04:38:53+0000","dateFinished":"2019-12-23T04:39:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:164"},{"text":"%pyspark\n\n# Trabalhando com conversões timestamp -> unix_timestamp e vice-versa\nrawDF \\\n    .withColumn(\"created_at\", col(\"created_at\").cast(TimestampType())) \\\n    .withColumn(\"created_at\", unix_timestamp(\"created_at\")) \\\n    .withColumn(\"created_at\", to_timestamp(\"created_at\")) \\\n    .show()","user":"anonymous","dateUpdated":"2019-12-23T04:39:02+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------------------+--------------------+--------------------+----------+----------+----------+\n|         created_at|            order_id|           status_id|     value|   dt_proc|        dt|\n+-------------------+--------------------+--------------------+----------+----------+----------+\n|2019-01-29 06:25:06|0115a7f2-be83-426...|0dd973d0-699c-4f8...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 04:25:00|0115a7f2-be83-426...|433e73d7-038c-497...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29 04:25:01|0115a7f2-be83-426...|bf1ff246-e7cb-45b...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 15:07:55|019c3f5a-8eac-4a1...|527ecc08-61a1-446...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29 17:10:10|019c3f5a-8eac-4a1...|ed9c0e40-5347-467...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 15:07:56|019c3f5a-8eac-4a1...|c1d41128-565d-4df...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 00:49:44|01e535f7-3922-458...|9a2b75d7-0c71-44e...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 00:49:43|01e535f7-3922-458...|5c877a80-365e-403...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29 02:50:04|01e535f7-3922-458...|7e71f1c2-1ecd-4b7...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 21:25:23|02d58f4b-88b6-490...|53f3b8c1-0748-46d...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 23:30:05|02d58f4b-88b6-490...|769932c7-c35b-438...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 21:25:22|02d58f4b-88b6-490...|e94a1a6d-ad83-451...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29 23:50:07|03672967-fd70-471...|6979e6c0-056b-4b9...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 21:48:39|03672967-fd70-471...|96e421ad-2fb4-469...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 21:48:38|03672967-fd70-471...|3c8f163a-3d37-497...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-30 00:20:08|0404790f-017a-4ae...|2648a9c2-bb10-4f1...| CONCLUDED|2019-12-23|2019-01-29|\n|2019-01-29 22:15:22|0404790f-017a-4ae...|13eaf495-fd3b-49e...|REGISTERED|2019-12-23|2019-01-29|\n|2019-01-29 22:15:23|0404790f-017a-4ae...|046f430f-1139-42a...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 22:32:31|044769cf-6884-4d3...|b11dca27-d079-48c...|    PLACED|2019-12-23|2019-01-29|\n|2019-01-29 22:32:30|044769cf-6884-4d3...|1737139d-7217-47d...|REGISTERED|2019-12-23|2019-01-29|\n+-------------------+--------------------+--------------------+----------+----------+----------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577065415515_709739298","id":"20191223-014335_43697411","dateCreated":"2019-12-23T01:43:35+0000","dateStarted":"2019-12-23T04:39:02+0000","dateFinished":"2019-12-23T04:39:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:165"},{"title":"Pivoteia a tabela","text":"%pyspark\n\n# Pivoteia a tabela a fim de termos os valores dos status de cada ordem em colunas distintas\npivotDF = rawDF \\\n    .drop(\"dt_proc\") \\\n    .withColumn(\"created_at\", col(\"created_at\").cast(TimestampType())) \\\n    .withColumn(\"created_at\", unix_timestamp(\"created_at\")) \\\n    .groupBy(\"order_id\") \\\n    .pivot(\"value\", [\"REGISTERED\", \"PLACED\", \"CONCLUDED\", \"CANCELLED\"]) \\\n    .min(\"created_at\") \\\n    .withColumn(\"registered\", to_timestamp(\"REGISTERED\")) \\\n    .withColumn(\"placed\", to_timestamp(\"PLACED\")) \\\n    .withColumn(\"concluded\", to_timestamp(\"CONCLUDED\")) \\\n    .withColumn(\"cancelled\", to_timestamp(\"CANCELLED\")) \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .withColumn(\"dt\", current_date())\n    \npivotDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-23T04:39:14+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+-------------------+-------------------+-------------------+---------+----------+----------+\n|order_id                            |registered         |placed             |concluded          |cancelled|dt_proc   |dt        |\n+------------------------------------+-------------------+-------------------+-------------------+---------+----------+----------+\n|1843e4be-3454-418d-9c2c-8b0a6a4d303f|2019-01-10 14:21:40|2019-01-10 14:21:41|2019-01-10 16:25:02|null     |2019-12-23|2019-12-23|\n|20d43d79-5692-46e2-a856-26e1f16fff1e|2019-01-10 23:07:18|2019-01-10 23:07:19|2019-01-11 01:10:10|null     |2019-12-23|2019-12-23|\n|22d6bb84-2169-4e22-92d9-218136575272|2019-01-10 00:10:38|2019-01-10 00:10:39|2019-01-10 02:15:02|null     |2019-12-23|2019-12-23|\n|2ff52441-3c5e-446f-82b1-c7814e0370cc|2019-01-10 14:28:35|2019-01-10 14:28:36|2019-01-10 16:30:29|null     |2019-12-23|2019-12-23|\n|30251b7f-03b1-4ac2-87cc-d3e6634a755b|2019-01-10 00:41:06|2019-01-10 00:41:07|2019-01-10 02:45:02|null     |2019-12-23|2019-12-23|\n+------------------------------------+-------------------+-------------------+-------------------+---------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577064647896_1859136089","id":"20191223-013047_257641669","dateCreated":"2019-12-23T01:30:47+0000","dateStarted":"2019-12-23T04:39:14+0000","dateFinished":"2019-12-23T04:39:28+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:166"},{"title":"Testa a veracidade da informação","text":"%pyspark\n\nrawDF.filter(col(\"order_id\") == \"1c97019e-f812-4798-80c6-7aeb81be4c25\").show(5, False)","user":"anonymous","dateUpdated":"2019-12-23T04:03:03+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|created_at              |order_id                            |status_id                           |value     |dt_proc   |dt        |\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n|2019-01-23T15:27:19.000Z|1c97019e-f812-4798-80c6-7aeb81be4c25|d99a0e7e-906f-462b-aa82-a659ac605b8f|REGISTERED|2019-12-23|2019-01-23|\n|2019-01-23T17:30:06.000Z|1c97019e-f812-4798-80c6-7aeb81be4c25|c7e6a3a6-199a-4129-9f94-430a0b6325d7|CONCLUDED |2019-12-23|2019-01-23|\n|2019-01-23T15:27:20.000Z|1c97019e-f812-4798-80c6-7aeb81be4c25|ec1399dc-c511-4bea-a28d-53ce1a6b8e96|PLACED    |2019-12-23|2019-01-23|\n+------------------------+------------------------------------+------------------------------------+----------+----------+----------+\n\n"}]},"apps":[],"jobName":"paragraph_1577065111305_-888140355","id":"20191223-013831_1971078754","dateCreated":"2019-12-23T01:38:31+0000","dateStarted":"2019-12-23T04:03:03+0000","dateFinished":"2019-12-23T04:03:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:167"},{"text":"%pyspark\n\npivotDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-23T02:20:44+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- order_id: string (nullable = true)\n |-- registered: timestamp (nullable = true)\n |-- placed: timestamp (nullable = true)\n |-- concluded: timestamp (nullable = true)\n |-- cancelled: timestamp (nullable = true)\n |-- dt_proc: date (nullable = false)\n\n"}]},"apps":[],"jobName":"paragraph_1577066824047_-1407091128","id":"20191223-020704_1153229193","dateCreated":"2019-12-23T02:07:04+0000","dateStarted":"2019-12-23T02:20:44+0000","dateFinished":"2019-12-23T02:20:48+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:168"},{"title":"Grava no diretório final","text":"%pyspark\n\n# Grava a tabela no diretório final\n# 125MB correspondem a aproximadamente 2.400.000 linhas\nnum_de_linhas = pivotDF.count()\ntotal_de_particoes = num_de_linhas / 2400000\n\npivotDF \\\n    .repartition(total_de_particoes) \\\n    .write.mode(\"overwrite\") \\\n    .partitionBy(\"dt\") \\\n    .option(\"compression\", \"snappy\") \\\n    .format(\"parquet\") \\\n    .save(destino_trusted)","user":"anonymous","dateUpdated":"2019-12-23T04:39:35+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577065792229_598933203","id":"20191223-014952_2099873042","dateCreated":"2019-12-23T01:49:52+0000","dateStarted":"2019-12-23T04:39:35+0000","dateFinished":"2019-12-23T04:40:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:169"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\ntrustedDF = spark.read.parquet(destino_trusted) \\\n    .select(\n        \"order_id\", \n        expr(\"registered as registered_\"), \n        expr(\"placed as placed_\"), \n        expr(\"concluded as concluded_\"), \n        expr(\"cancelled as cancelled_\")) \\\n    .orderBy(\"order_id\")\n\n# Monta a tabela comparativa\ncompDF = rawDF \\\n    .groupBy(\"order_id\", \"value\") \\\n    .agg(min(\"created_at\").alias(\"created_at\")) \\\n    .withColumn(\"registered\", expr(\"case when value == 'REGISTERED' then created_at else null end\")) \\\n    .withColumn(\"placed\", expr(\"case when value == 'PLACED' then created_at else null end\")) \\\n    .withColumn(\"concluded\", expr(\"case when value == 'CONCLUDED' then created_at else null end\")) \\\n    .withColumn(\"cancelled\", expr(\"case when value == 'CANCELLED' then created_at else null end\")) \\\n    .withColumn(\"registered\", col(\"registered\").cast(TimestampType())) \\\n    .withColumn(\"placed\", col(\"placed\").cast(TimestampType())) \\\n    .withColumn(\"concluded\", col(\"concluded\").cast(TimestampType())) \\\n    .withColumn(\"cancelled\", col(\"cancelled\").cast(TimestampType())) \\\n    .drop(\"value\") \\\n    .orderBy(\"order_id\") \n\n#compDF.show(5, False)\n\n# Compara as variáveis e valida os resultados\nvalidaDF = compDF \\\n    .join(trustedDF, on=[\"order_id\"], how=\"left\") \\\n    .withColumn(\"fl_registered\", expr(\"case when coalesce(registered, registered_, '9999-12-31 00:00:00') = coalesce(registered_, '9999-12-31 00:00:00') then 0 else 1 end\")) \\\n    .withColumn(\"fl_placed\", expr(\"case when coalesce(placed, placed_, '9999-12-31 00:00:00') = coalesce(placed_, '9999-12-31 00:00:00') then 0 else 1 end\")) \\\n    .withColumn(\"fl_concluded\", expr(\"case when coalesce(concluded, concluded_, '9999-12-31 00:00:00') = coalesce(concluded_, '9999-12-31 00:00:00') then 0 else 1 end\")) \\\n    .withColumn(\"fl_cancelled\", expr(\"case when coalesce(cancelled, cancelled_, '9999-12-31 00:00:00')  = coalesce(cancelled_, '9999-12-31 00:00:00') then 0 else 1 end\"))\n\n# Faz a contagem de valores desiguais\nerrosDF = validaDF \\\n    .withColumn(\"dummy\", lit(\"1\")) \\\n    .groupBy(\"dummy\") \\\n    .agg(\n        sum(\"fl_registered\").alias(\"err_registered\"),\n        sum(\"fl_placed\").alias(\"err_placed\"),\n        sum(\"fl_concluded\").alias(\"err_concluded\"),\n        sum(\"fl_cancelled\").alias(\"err_cancelled\")) \\\n    .withColumn(\"total\", col(\"err_registered\") + col(\"err_placed\") + col(\"err_concluded\") + col(\"err_cancelled\"))\n\ntotal_de_erros = errosDF.select(\"total\").take(1)[0][\"total\"]\n\nprint(\"> Total de valores desiguais confirmados: {}\".format(total_de_erros))","user":"anonymous","dateUpdated":"2019-12-23T04:19:49+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Total de valores desiguais confirmados: 0\n"}]},"apps":[],"jobName":"paragraph_1577066988739_-321499719","id":"20191223-020948_1107924447","dateCreated":"2019-12-23T02:09:48+0000","dateStarted":"2019-12-23T04:19:49+0000","dateFinished":"2019-12-23T04:20:20+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:170"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-23T04:18:47+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577074727075_1826850729","id":"20191223-041847_483506837","dateCreated":"2019-12-23T04:18:47+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:171"}],"name":"ifood-trusted-order-status-dev","id":"2EYAUNFCZ","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}