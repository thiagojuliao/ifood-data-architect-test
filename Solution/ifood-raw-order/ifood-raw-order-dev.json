{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Definição do Schema de garnishItems que é um Array dentro de Items\nschema_value_currency = StructType([StructField(\"value\", StringType()), StructField(\"currency\", StringType())])\nschema_garnish = StructType(\n    [\n        StructField(\"name\", StringType()),\n        StructField(\"addition\", schema_value_currency),\n        StructField(\"discount\", schema_value_currency),\n        StructField(\"quantity\", DoubleType()),\n        StructField(\"sequence\", IntegerType()),\n        StructField(\"unitPrice\", schema_value_currency),\n        StructField(\"categoryId\", StringType()),\n        StructField(\"externalId\", StringType()),\n        StructField(\"totalValue\", schema_value_currency),\n        StructField(\"categoryName\", StringType()),\n        StructField(\"integrationId\", StringType())\n    ])\n\n# Definição do Schema do Array de Items\nschema_items = StructType(\n    [\n        StructField(\"name\", StringType()),\n        StructField(\"addition\", schema_value_currency),\n        StructField(\"discount\", schema_value_currency),\n        StructField(\"quantity\", DoubleType()),\n        StructField(\"sequence\", IntegerType()),\n        StructField(\"unitPrice\", schema_value_currency),\n        StructField(\"externalId\", StringType()),\n        StructField(\"totalValue\", schema_value_currency),\n        StructField(\"customerNote\", StringType()),\n        StructField(\"garnishItems\", ArrayType(schema_garnish)),\n        StructField(\"integrationId\", StringType()),\n        StructField(\"totalAddition\", schema_value_currency),\n        StructField(\"totalDiscount\", schema_value_currency)\n    ])\n\n# Definação do schema json\nschema = StructType(\n    [\n        StructField(\"cpf\", StringType()),\n        StructField(\"customer_id\", StringType()),\n        StructField(\"customer_name\", StringType()),\n        StructField(\"delivery_address_city\", StringType()),\n        StructField(\"delivery_address_country\", StringType()),\n        StructField(\"delivery_address_district\", StringType()),\n        StructField(\"delivery_address_external_id\", StringType()),\n        StructField(\"delivery_address_latitude\", StringType()),\n        StructField(\"delivery_address_longitude\", StringType()),\n        StructField(\"delivery_address_state\", StringType()),\n        StructField(\"delivery_address_zip_code\", StringType()),\n        StructField(\"items\", ArrayType(schema_items)),\n        StructField(\"merchant_id\", StringType()),\n        StructField(\"merchant_latitude\", StringType()),\n        StructField(\"merchant_longitude\", StringType()),\n        StructField(\"merchant_timezone\", StringType()),\n        StructField(\"order_created_at\", StringType()),\n        StructField(\"order_id\", StringType()),\n        StructField(\"order_scheduled\", BooleanType()),\n        StructField(\"order_scheduled_date\", StringType()),\n        StructField(\"order_total_amount\", DoubleType()),\n        StructField(\"origin_platform\", StringType())\n    ])\n\n# Caminho de origem da pouso order\norigem_pouso = \"s3://ifood-landing-order/full-load/order.json.gz\"\n\n# Caminho de destino da simulação\ndestino_simul = \"s3://ifood-landing-order/\"\n\n# Caminho de destino da raw order\ndestino_raw = \"s3://ifood-raw-order/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-landing-order-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-24T14:07:31+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577195490206_-415336704","id":"20191221-124444_835401478","dateCreated":"2019-12-24T13:51:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:311","dateFinished":"2019-12-24T14:07:31+0000","dateStarted":"2019-12-24T14:07:31+0000"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.schema(schema).json(origem_pouso).persist(StorageLevel.DISK_ONLY)\nprint(\"> Volumetria da pouso orders: {}\".format(pousoDF.count()))","user":"anonymous","dateUpdated":"2019-12-24T14:07:49+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria da pouso orders: 3683040\n"}]},"apps":[],"jobName":"paragraph_1577195490207_-174224488","id":"20191221-124622_2019804708","dateCreated":"2019-12-24T13:51:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:312","dateFinished":"2019-12-24T14:11:30+0000","dateStarted":"2019-12-24T14:07:49+0000"},{"text":"%pyspark\n\npousoDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-24T14:11:48+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- cpf: string (nullable = true)\n |-- customer_id: string (nullable = true)\n |-- customer_name: string (nullable = true)\n |-- delivery_address_city: string (nullable = true)\n |-- delivery_address_country: string (nullable = true)\n |-- delivery_address_district: string (nullable = true)\n |-- delivery_address_external_id: string (nullable = true)\n |-- delivery_address_latitude: string (nullable = true)\n |-- delivery_address_longitude: string (nullable = true)\n |-- delivery_address_state: string (nullable = true)\n |-- delivery_address_zip_code: string (nullable = true)\n |-- items: array (nullable = true)\n |    |-- element: struct (containsNull = true)\n |    |    |-- name: string (nullable = true)\n |    |    |-- addition: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |    |    |-- discount: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |    |    |-- quantity: double (nullable = true)\n |    |    |-- sequence: integer (nullable = true)\n |    |    |-- unitPrice: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |    |    |-- externalId: string (nullable = true)\n |    |    |-- totalValue: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |    |    |-- customerNote: string (nullable = true)\n |    |    |-- garnishItems: array (nullable = true)\n |    |    |    |-- element: struct (containsNull = true)\n |    |    |    |    |-- name: string (nullable = true)\n |    |    |    |    |-- addition: struct (nullable = true)\n |    |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |    |-- discount: struct (nullable = true)\n |    |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |    |-- quantity: double (nullable = true)\n |    |    |    |    |-- sequence: integer (nullable = true)\n |    |    |    |    |-- unitPrice: struct (nullable = true)\n |    |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |    |-- categoryId: string (nullable = true)\n |    |    |    |    |-- externalId: string (nullable = true)\n |    |    |    |    |-- totalValue: struct (nullable = true)\n |    |    |    |    |    |-- value: string (nullable = true)\n |    |    |    |    |    |-- currency: string (nullable = true)\n |    |    |    |    |-- categoryName: string (nullable = true)\n |    |    |    |    |-- integrationId: string (nullable = true)\n |    |    |-- integrationId: string (nullable = true)\n |    |    |-- totalAddition: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |    |    |-- totalDiscount: struct (nullable = true)\n |    |    |    |-- value: string (nullable = true)\n |    |    |    |-- currency: string (nullable = true)\n |-- merchant_id: string (nullable = true)\n |-- merchant_latitude: string (nullable = true)\n |-- merchant_longitude: string (nullable = true)\n |-- merchant_timezone: string (nullable = true)\n |-- order_created_at: string (nullable = true)\n |-- order_id: string (nullable = true)\n |-- order_scheduled: boolean (nullable = true)\n |-- order_scheduled_date: string (nullable = true)\n |-- order_total_amount: double (nullable = true)\n |-- origin_platform: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1577195490207_503057769","id":"20191221-124723_98133630","dateCreated":"2019-12-24T13:51:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:313","dateFinished":"2019-12-24T14:11:48+0000","dateStarted":"2019-12-24T14:11:48+0000"},{"text":"%pyspark\n\npousoDF.show(1, False)","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\n|cpf        |customer_id                         |customer_name|delivery_address_city|delivery_address_country|delivery_address_district|delivery_address_external_id|delivery_address_latitude|delivery_address_longitude|delivery_address_state|delivery_address_zip_code|items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |merchant_id                         |merchant_latitude|merchant_longitude|merchant_timezone|order_created_at        |order_id                            |order_scheduled|order_scheduled_date|order_total_amount|origin_platform|\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\n|80532101763|977b9a89-825f-464b-8ef6-0f453d7334c1|GUSTAVO      |FRANCA               |BR                      |JARDIM ESPRAIADO         |6736655                     |-47.39                   |-20.55                    |SP                    |14403                    |[{\"name\": \"Parmegiana de Filé de Frango (2 pessoas)\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 1, \"unitPrice\": {\"value\": \"2800\", \"currency\": \"BRL\"}, \"externalId\": \"0bcd6764fd5e466d9c04b18ac0eb69e6\", \"totalValue\": {\"value\": \"2800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [{\"name\": \"COM Arroz branco\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 2, \"unitPrice\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryId\": \"13HDH\", \"externalId\": \"384bd2b4eb7d454d8e0274e7d590ab4f\", \"totalValue\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryName\": \"PERSONALIZAR\", \"integrationId\": null}], \"integrationId\": \"PMFR\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}, {\"name\": \"Lasanha Frango (2 pessoas)\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 3, \"unitPrice\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"externalId\": \"a361f5eec6a44ac0817892e81bf22e80\", \"totalValue\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [], \"integrationId\": \"LF\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}]|eb4197f9-964c-4f87-8307-709e498aab87|-47.39           |-20.55            |America/Sao_Paulo|2019-01-17T22:50:06.000Z|dd4f8f0a-c2cb-45c6-a002-c3be6b305e5f|false          |null                |46.0              |ANDROID        |\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\nonly showing top 1 row\n\n"}]},"apps":[],"jobName":"paragraph_1577195490207_603208885","id":"20191221-124732_945883820","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:314"},{"text":"%pyspark\n\n# Verificação de duplicidade na(s) chave(s)\n# Possuímos duplicidade na(s) chave(s) logo devemos verificar!\npousoDF.groupBy(\"order_id\").agg(count(\"*\").alias(\"dup\")).filter(col(\"dup\") > 1).show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+---+\n|order_id                            |dup|\n+------------------------------------+---+\n|20f03b24-f730-4b5e-9109-13046ddd0d96|2  |\n|6f2cf11d-7dee-476b-819f-406849182a8b|2  |\n|bb49078a-040b-4153-ab80-eaf384052df0|2  |\n|ad12c3a6-512c-41c9-b597-33be7fb931bd|2  |\n|0d40927c-9c95-4a25-a56d-db5942a2352c|2  |\n+------------------------------------+---+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1577195490207_1697678203","id":"20191221-124745_36091137","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:315"},{"text":"%pyspark\n\n# Aqui notamos que a duplicidade vem do fato de termos mesmos customer_ids com cpfs distintos o que é improvável dado que o cpf é único por pessoa\n# Outro detalhe é que temos order_created_at diferentes para um mesmo order_id\npousoDF.filter(col(\"order_id\") == \"20f03b24-f730-4b5e-9109-13046ddd0d96\").show(5, False)","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\n|cpf        |customer_id                         |customer_name|delivery_address_city|delivery_address_country|delivery_address_district|delivery_address_external_id|delivery_address_latitude|delivery_address_longitude|delivery_address_state|delivery_address_zip_code|items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |merchant_id                         |merchant_latitude|merchant_longitude|merchant_timezone|order_created_at        |order_id                            |order_scheduled|order_scheduled_date|order_total_amount|origin_platform|\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\n|51245332952|6fb1bd29-be67-4da8-8813-9c7adec48342|GLAUBER      |MARILIA              |BR                      |JARDIM PORTAL DO SOL     |7350959                     |-49.94                   |-22.23                    |SP                    |17519                    |[{\"name\": \"Polenta Frita 500g\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 3, \"unitPrice\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"externalId\": \"30be8ee82ab241109f82ccb3478bd3ff\", \"totalValue\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [], \"integrationId\": null, \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}, {\"name\": \"CROC-TORI\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 2.00, \"sequence\": 1, \"unitPrice\": {\"value\": \"2500\", \"currency\": \"BRL\"}, \"externalId\": \"b07cd13753054ba98b131344101062ea\", \"totalValue\": {\"value\": \"5000\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [{\"name\": \"- Molho SIM\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 2.00, \"sequence\": 2, \"unitPrice\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryId\": \"14I31\", \"externalId\": \"05fe15e3df5b4cc68de41fbaf7f82cf6\", \"totalValue\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryName\": \"Enviar Molho que Acompanha ?\", \"integrationId\": null}], \"integrationId\": \"0000\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}]|9dbb8bd7-2503-44f0-9012-17beebc3ced6|-49.94           |-22.23            |America/Sao_Paulo|2019-01-28T21:43:09.000Z|20f03b24-f730-4b5e-9109-13046ddd0d96|false          |null                |68.0              |ANDROID        |\n|05383195513|6fb1bd29-be67-4da8-8813-9c7adec48342|GLAUBER      |MARILIA              |BR                      |JARDIM PORTAL DO SOL     |7350959                     |-49.94                   |-22.23                    |SP                    |17519                    |[{\"name\": \"Polenta Frita 500g\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 3, \"unitPrice\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"externalId\": \"30be8ee82ab241109f82ccb3478bd3ff\", \"totalValue\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [], \"integrationId\": null, \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}, {\"name\": \"CROC-TORI\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 2.00, \"sequence\": 1, \"unitPrice\": {\"value\": \"2500\", \"currency\": \"BRL\"}, \"externalId\": \"b07cd13753054ba98b131344101062ea\", \"totalValue\": {\"value\": \"5000\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [{\"name\": \"- Molho SIM\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 2.00, \"sequence\": 2, \"unitPrice\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryId\": \"14I31\", \"externalId\": \"05fe15e3df5b4cc68de41fbaf7f82cf6\", \"totalValue\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryName\": \"Enviar Molho que Acompanha ?\", \"integrationId\": null}], \"integrationId\": \"0000\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}]|9dbb8bd7-2503-44f0-9012-17beebc3ced6|-49.94           |-22.23            |America/Sao_Paulo|2018-12-29T21:43:09.000Z|20f03b24-f730-4b5e-9109-13046ddd0d96|false          |null                |68.0              |ANDROID        |\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+\n\n"}]},"apps":[],"jobName":"paragraph_1577195490208_-1350554052","id":"20191221-131619_2122087846","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:316"},{"title":"Simulando uma ingestão produtiva","text":"%pyspark\n\npousoDF.select(max(\"order_created_at\")).limit(1).take(1)","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[Row(max(order_created_at)=u'2019-01-31T23:59:59.000Z')]\n"}]},"apps":[],"jobName":"paragraph_1577195490208_5724331","id":"20191221-161955_2079105026","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:317"},{"text":"%pyspark\n\npousoDF \\\n    .withColumn(\"dt\", col(\"order_created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") == \"2019-01-31\") \\\n    .write.partitionBy(\"dt\") \\\n    .mode(\"overwrite\").format(\"json\").save(destino_simul)","user":"anonymous","dateUpdated":"2019-12-24T14:12:34+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577195490208_-1925308771","id":"20191221-162035_1252608566","dateCreated":"2019-12-24T13:51:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:318","dateFinished":"2019-12-24T14:12:35+0000","dateStarted":"2019-12-24T14:12:34+0000"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .withColumn(\"dt\", col(\"order_created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") != \"2019-01-31\")\n\nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-24T14:12:43+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1577195490209_762658073","id":"20191221-124855_1400670421","dateCreated":"2019-12-24T13:51:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:319","dateFinished":"2019-12-24T14:16:34+0000","dateStarted":"2019-12-24T14:12:43+0000"},{"text":"%pyspark\n\nrawDF.show(1, False)","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+----------+----------+\n|cpf        |customer_id                         |customer_name|delivery_address_city|delivery_address_country|delivery_address_district|delivery_address_external_id|delivery_address_latitude|delivery_address_longitude|delivery_address_state|delivery_address_zip_code|items                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |merchant_id                         |merchant_latitude|merchant_longitude|merchant_timezone|order_created_at        |order_id                            |order_scheduled|order_scheduled_date|order_total_amount|origin_platform|dt_proc   |dt        |\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+----------+----------+\n|80532101763|977b9a89-825f-464b-8ef6-0f453d7334c1|GUSTAVO      |FRANCA               |BR                      |JARDIM ESPRAIADO         |6736655                     |-47.39                   |-20.55                    |SP                    |14403                    |[{\"name\": \"Parmegiana de Filé de Frango (2 pessoas)\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 1, \"unitPrice\": {\"value\": \"2800\", \"currency\": \"BRL\"}, \"externalId\": \"0bcd6764fd5e466d9c04b18ac0eb69e6\", \"totalValue\": {\"value\": \"2800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [{\"name\": \"COM Arroz branco\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 2, \"unitPrice\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryId\": \"13HDH\", \"externalId\": \"384bd2b4eb7d454d8e0274e7d590ab4f\", \"totalValue\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"categoryName\": \"PERSONALIZAR\", \"integrationId\": null}], \"integrationId\": \"PMFR\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}, {\"name\": \"Lasanha Frango (2 pessoas)\", \"addition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"discount\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"quantity\": 1.00, \"sequence\": 3, \"unitPrice\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"externalId\": \"a361f5eec6a44ac0817892e81bf22e80\", \"totalValue\": {\"value\": \"1800\", \"currency\": \"BRL\"}, \"customerNote\": null, \"garnishItems\": [], \"integrationId\": \"LF\", \"totalAddition\": {\"value\": \"0\", \"currency\": \"BRL\"}, \"totalDiscount\": {\"value\": \"0\", \"currency\": \"BRL\"}}]|eb4197f9-964c-4f87-8307-709e498aab87|-47.39           |-20.55            |America/Sao_Paulo|2019-01-17T22:50:06.000Z|dd4f8f0a-c2cb-45c6-a002-c3be6b305e5f|false          |null                |46.0              |ANDROID        |2019-12-21|2019-01-17|\n+-----------+------------------------------------+-------------+---------------------+------------------------+-------------------------+----------------------------+-------------------------+--------------------------+----------------------+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------+-----------------+------------------+-----------------+------------------------+------------------------------------+---------------+--------------------+------------------+---------------+----------+----------+\nonly showing top 1 row\n\n"}]},"apps":[],"jobName":"paragraph_1577195490209_-1353134898","id":"20191221-125227_830449066","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:320"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw + \"/*/*.parquet\")\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\ncolunas = pousoDF.columns\ncolunas_ = rawDF_.drop(\"dt_proc\").columns\ncolunas.sort()\ncolunas_.sort()\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_ or colunas == colunas_))","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> True\n> O schema de saída equivale-se ao de entrada ? ---> True\n"}]},"apps":[],"jobName":"paragraph_1577195490209_397767127","id":"20191221-125122_890996710","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:321"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-24T13:51:30+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577195490209_948601095","id":"20191221-134217_728581033","dateCreated":"2019-12-24T13:51:30+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:322"}],"name":"ifood-raw-order-dev","id":"2EYTCANQ4","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}