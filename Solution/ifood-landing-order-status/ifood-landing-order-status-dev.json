{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Caminho de origem da pouso order-status\norigem_pouso = \"s3://ifood-landing-order-status/full-load/status.json.gz\"\n\n# Caminho de destino da simulação\ndestino_simul = \"s3://ifood-landing-order-status/\"\n\n# Caminho de destino da raw order\ndestino_raw = \"s3://ifood-raw-order-status/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-landing-order-status-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-21T17:00:40+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576937589431_-123556929","id":"20191221-124444_835401478","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T17:00:40+0000","dateFinished":"2019-12-21T17:00:40+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:172"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.json(origem_pouso).persist(StorageLevel.DISK_ONLY)\nprint(\"> Volumetria da pouso orders: {}\".format(pousoDF.count()))","user":"anonymous","dateUpdated":"2019-12-21T17:00:47+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria da pouso orders: 11075048\n"}]},"apps":[],"jobName":"paragraph_1576937589431_118449529","id":"20191221-124622_2019804708","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T17:00:47+0000","dateFinished":"2019-12-21T17:01:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:173"},{"text":"%pyspark\n\npousoDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-21T14:23:07+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- created_at: string (nullable = true)\n |-- order_id: string (nullable = true)\n |-- status_id: string (nullable = true)\n |-- value: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1576937589431_-585336519","id":"20191221-124723_98133630","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T14:23:07+0000","dateFinished":"2019-12-21T14:23:07+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:174"},{"text":"%pyspark\n\npousoDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T17:01:37+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------+------------------------------------+------------------------------------+----------+\n|created_at              |order_id                            |status_id                           |value     |\n+------------------------+------------------------------------+------------------------------------+----------+\n|2019-01-25T01:05:07.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|b4298862-fa38-499a-93e2-a76930fb2bce|CONCLUDED |\n|2019-01-24T23:04:27.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|7964bf63-007a-484d-a321-e9118ccc2f97|REGISTERED|\n|2019-01-24T23:04:28.000Z|0002fe02-d7dc-4232-b7ac-3394019ce240|ca16b92b-db8f-4274-b165-929675541a9f|PLACED    |\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |\n|2019-01-18T00:45:02.000Z|000cef8c-83c7-49eb-a0fb-404e6dc2150e|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |\n+------------------------+------------------------------------+------------------------------------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1576937589432_-868721163","id":"20191221-124732_945883820","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T17:01:37+0000","dateFinished":"2019-12-21T17:01:37+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:175"},{"text":"%pyspark\n\n# Domínio da coluna value\npousoDF.select(\"value\").dropDuplicates().show(20, False)","user":"anonymous","dateUpdated":"2019-12-21T14:24:44+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+\n|value     |\n+----------+\n|CONCLUDED |\n|REGISTERED|\n|CANCELLED |\n|PLACED    |\n+----------+\n\n"}]},"apps":[],"jobName":"paragraph_1576937877257_-512910692","id":"20191221-141757_50170210","dateCreated":"2019-12-21T14:17:57+0000","dateStarted":"2019-12-21T14:18:14+0000","dateFinished":"2019-12-21T14:18:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:176"},{"text":"%pyspark\n\n# Verificação de duplicidade na(s) chave(s)\n# Possuímos duplicidade na(s) chave(s) logo devemos verificar!\npousoDF.groupBy(\"order_id\", \"status_id\", \"value\").agg(count(\"*\").alias(\"dup\")).filter(col(\"dup\") > 1).show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T14:24:07+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------------------+----------+---+\n|order_id                            |status_id                           |value     |dup|\n+------------------------------------+------------------------------------+----------+---+\n|021fc1cd-4812-443a-9e0c-d988923e72e1|a3e318a7-fd42-4d8e-8c1c-9c8aee92ab59|REGISTERED|2  |\n|02ef87b3-8ee3-4234-a914-1721ad32be20|fde7110c-1560-48eb-98dc-e241a4c22b48|REGISTERED|2  |\n|07f62f89-3590-4c9a-affb-bacc0f682eb5|2d5f468b-f52a-492f-926d-05be53cf1bfc|REGISTERED|2  |\n|0f7e443d-8ec7-46b6-bf79-9eb8411d03a0|6433b468-80c0-4277-bc94-1f9eac8496c7|PLACED    |2  |\n|0f93305d-7363-4b9c-941e-8dbff6de61f4|3be8a247-561a-47c9-815b-af9fd6469b7c|REGISTERED|2  |\n+------------------------------------+------------------------------------+----------+---+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1576937589432_-1041883082","id":"20191221-124745_36091137","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T14:24:07+0000","dateFinished":"2019-12-21T14:24:24+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:177"},{"title":"Simulando uma ingestão produtiva","text":"%pyspark\n\npousoDF.select(max(\"created_at\")).limit(1).take(1)","user":"anonymous","dateUpdated":"2019-12-21T17:03:29+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[Row(max(created_at)=u'2019-01-31T23:59:59.000Z')]\n"}]},"apps":[],"jobName":"paragraph_1576947777400_-493557098","id":"20191221-170257_732133357","dateCreated":"2019-12-21T17:02:57+0000","dateStarted":"2019-12-21T17:03:29+0000","dateFinished":"2019-12-21T17:03:31+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:178"},{"text":"%pyspark\n\npousoDF \\\n    .withColumn(\"dt\", col(\"created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") == \"2019-01-31\") \\\n    .write.partitionBy(\"dt\") \\\n    .mode(\"append\").format(\"json\").save(destino_simul)","user":"anonymous","dateUpdated":"2019-12-21T17:03:53+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576947810952_1090113537","id":"20191221-170330_634990094","dateCreated":"2019-12-21T17:03:30+0000","dateStarted":"2019-12-21T17:03:53+0000","dateFinished":"2019-12-21T17:04:07+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:179"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF_ \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .withColumn(\"dt\", col(\"created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") != \"2019-01-31\") \\\n    .dropDuplicates()\n    \nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-21T17:04:45+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576937589433_1253596411","id":"20191221-124855_1400670421","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T17:04:45+0000","dateFinished":"2019-12-21T17:08:42+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:180"},{"text":"%pyspark\n\nrawDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T14:54:19+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------+------------------------------------+----------+----------+----------+\n|order_id                            |created_at              |status_id                           |value     |dt        |dt_proc   |\n+------------------------------------+------------------------+------------------------------------+----------+----------+----------+\n|0002fe02-d7dc-4232-b7ac-3394019ce240|2019-01-25T01:05:07.000Z|b4298862-fa38-499a-93e2-a76930fb2bce|CONCLUDED |2019-01-24|2019-12-21|\n|0002fe02-d7dc-4232-b7ac-3394019ce240|2019-01-24T23:04:27.000Z|7964bf63-007a-484d-a321-e9118ccc2f97|REGISTERED|2019-01-24|2019-12-21|\n|0002fe02-d7dc-4232-b7ac-3394019ce240|2019-01-24T23:04:28.000Z|ca16b92b-db8f-4274-b165-929675541a9f|PLACED    |2019-01-24|2019-12-21|\n|000cef8c-83c7-49eb-a0fb-404e6dc2150e|2019-01-18T00:45:02.000Z|bf43cc29-c3c1-4f3a-9a6c-deb902ca286c|CONCLUDED |2019-01-17|2019-12-21|\n|000cef8c-83c7-49eb-a0fb-404e6dc2150e|2019-01-17T22:42:18.000Z|6edee034-b55b-407a-b114-eb9a475ae52a|PLACED    |2019-01-17|2019-12-21|\n+------------------------------------+------------------------+------------------------------------+----------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1576937589433_2035982334","id":"20191221-125227_830449066","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T14:54:19+0000","dateFinished":"2019-12-21T14:56:58+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:181"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw + \"/*/*.parquet\")\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.dropDuplicates().count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_))","user":"anonymous","dateUpdated":"2019-12-21T17:13:47+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> False\n> O schema de saída equivale-se ao de entrada ? ---> False\n"}]},"apps":[],"jobName":"paragraph_1576937589433_-1666691056","id":"20191221-125122_890996710","dateCreated":"2019-12-21T14:13:09+0000","dateStarted":"2019-12-21T17:10:16+0000","dateFinished":"2019-12-21T17:10:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:182"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-21T15:06:00+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1576940760568_-313825638","id":"20191221-150600_1332728574","dateCreated":"2019-12-21T15:06:00+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:183"}],"name":"ifood-landing-order-status-dev","id":"2EX3NDF94","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}