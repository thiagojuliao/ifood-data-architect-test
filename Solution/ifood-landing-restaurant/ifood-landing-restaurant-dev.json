{"paragraphs":[{"title":"Inicialização dos pacotes, definindo funções e variáveis","text":"%pyspark\n\n###############################################\n#   Importando pacotes & definindo funções    #\n###############################################\n\nfrom datetime import *\nfrom pyspark import StorageLevel\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.types import *\n\n###############################\n#   Definição de variáveis    #\n###############################\n\n# Caminho de origem da pouso restaurant\norigem_pouso = \"s3://ifood-landing-restaurant/full-load/restaurant.csv.gz\"\n\n# Caminho de destino da raw restaurant\ndestino_raw = \"s3://ifood-raw-restaurant/\"\n\n# Caminho de destino da simulação produtiva\ndestino_simul = \"s3://ifood-landing-restaurant/\"\n\n# Inicia sessão spark\nspark = SparkSession.builder.appName(\"ifood-landing-restaurant-dev\").getOrCreate()\n\n# Configurações básicas para o spark\nspark.conf.set(\"spark.sql.maxPartitionBytes\", 200 * 1024 * 1024) # Seta a quantidade máxima de bytes em uma partição ao ler os arquivos de entrada (Entre 100MB e 200MB é o ideal)\nspark.conf.set(\"spark.sql.sources.partitionOverwriteMode\", \"DYNAMIC\") # Necessário para sobrescrever partições ","user":"anonymous","dateUpdated":"2019-12-21T16:06:08+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576932284554_2066856523","id":"20191221-124444_835401478","dateCreated":"2019-12-21T12:44:44+0000","dateStarted":"2019-12-21T16:06:08+0000","dateFinished":"2019-12-21T16:06:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:172"},{"title":"Lê os dados da origem","text":"%pyspark\n\n# Lê a pouso de origem\npousoDF = spark.read.option(\"header\", True).csv(origem_pouso)","user":"anonymous","dateUpdated":"2019-12-21T16:06:11+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576932382795_-1977070481","id":"20191221-124622_2019804708","dateCreated":"2019-12-21T12:46:22+0000","dateStarted":"2019-12-21T16:06:11+0000","dateFinished":"2019-12-21T16:06:12+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:173"},{"text":"%pyspark\n\npousoDF.printSchema()","user":"anonymous","dateUpdated":"2019-12-21T12:47:32+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- id: string (nullable = true)\n |-- created_at: string (nullable = true)\n |-- enabled: string (nullable = true)\n |-- price_range: string (nullable = true)\n |-- average_ticket: string (nullable = true)\n |-- takeout_time: string (nullable = true)\n |-- delivery_time: string (nullable = true)\n |-- minimum_order_value: string (nullable = true)\n |-- merchant_zip_code: string (nullable = true)\n |-- merchant_city: string (nullable = true)\n |-- merchant_state: string (nullable = true)\n |-- merchant_country: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1576932443486_-693360591","id":"20191221-124723_98133630","dateCreated":"2019-12-21T12:47:23+0000","dateStarted":"2019-12-21T12:47:32+0000","dateFinished":"2019-12-21T12:47:32+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:174"},{"text":"%pyspark\n\npousoDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T12:47:45+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\n|id                                  |created_at              |enabled|price_range|average_ticket|takeout_time|delivery_time|minimum_order_value|merchant_zip_code|merchant_city |merchant_state|merchant_country|\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\n|02c94103-61f3-4906-a4a9-55611db9f28c|2017-01-23T12:52:30.910Z|false  |3          |60.0          |0           |50           |30.0               |14025            |RIBEIRAO PRETO|SP            |BR              |\n|15e7f5fd-090d-47b9-9f14-b6f7fce3c95d|2017-01-20T13:14:48.286Z|true   |3          |60.0          |0           |0            |30.0               |50180            |SAO PAULO     |SP            |BR              |\n|33ca5d3d-b99f-404d-84d9-8df8f38a2261|2017-01-23T12:46:33.457Z|true   |5          |100.0         |0           |45           |10.0               |23090            |RIO DE JANEIRO|RJ            |BR              |\n|4927035f-a343-4a65-a9be-945818e2efff|2017-01-20T13:15:04.806Z|true   |3          |80.0          |0           |0            |18.9               |40255            |SALVADOR      |BA            |BR              |\n|52feaad8-4961-4afc-8d60-3f29ffd0a7a7|2017-01-20T13:14:27.701Z|true   |3          |60.0          |0           |0            |25.0               |64600            |BARUERI       |SP            |BR              |\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1576932452749_-1607858904","id":"20191221-124732_945883820","dateCreated":"2019-12-21T12:47:32+0000","dateStarted":"2019-12-21T12:47:45+0000","dateFinished":"2019-12-21T12:47:46+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:175"},{"text":"%pyspark\n\n# Verificação de duplicidade na(s) chave(s)\npousoDF.groupBy(\"id\").agg(count(\"*\").alias(\"dup\")).filter(col(\"dup\") > 1).show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T12:49:27+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---+---+\n|id |dup|\n+---+---+\n+---+---+\n\n"}]},"apps":[],"jobName":"paragraph_1576932465922_1883509237","id":"20191221-124745_36091137","dateCreated":"2019-12-21T12:47:45+0000","dateStarted":"2019-12-21T12:48:55+0000","dateFinished":"2019-12-21T12:48:58+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:176"},{"title":"Simulando uma ingestão produtiva","text":"%pyspark\n\npousoDF.select(max(\"created_at\")).limit(1).take(1)","user":"anonymous","dateUpdated":"2019-12-21T16:07:04+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[Row(max(created_at)=u'2017-01-23T12:54:52.155Z')]\n"}]},"apps":[],"jobName":"paragraph_1576944378461_342159926","id":"20191221-160618_1896001307","dateCreated":"2019-12-21T16:06:18+0000","dateStarted":"2019-12-21T16:07:04+0000","dateFinished":"2019-12-21T16:07:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:177"},{"text":"%pyspark\n\npousoDF \\\n    .withColumn(\"dt\", col(\"created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") == \"2017-01-23\") \\\n    .write.partitionBy(\"dt\") \\\n    .mode(\"append\").option(\"header\", True).format(\"csv\").save(destino_simul)","user":"anonymous","dateUpdated":"2019-12-21T16:07:38+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576944426585_1473599554","id":"20191221-160706_1940343493","dateCreated":"2019-12-21T16:07:06+0000","dateStarted":"2019-12-21T16:07:38+0000","dateFinished":"2019-12-21T16:07:38+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:178"},{"title":"Cria e grava a tabela raw","text":"%pyspark\n\n# Cria a tabela raw\nrawDF = pousoDF \\\n    .withColumn(\"dt_proc\", current_date()) \\\n    .withColumn(\"dt\", col(\"created_at\").cast(DateType())) \\\n    .filter(col(\"dt\") != \"2017-01-23\")\n\nrawDF.write.partitionBy(\"dt\").mode(\"overwrite\").option(\"compression\", \"snappy\").format(\"parquet\").save(destino_raw)","user":"anonymous","dateUpdated":"2019-12-21T16:08:21+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1576932535301_-1089228794","id":"20191221-124855_1400670421","dateCreated":"2019-12-21T12:48:55+0000","dateStarted":"2019-12-21T16:08:21+0000","dateFinished":"2019-12-21T16:08:22+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:179"},{"text":"%pyspark\n\nrawDF.show(5, False)","user":"anonymous","dateUpdated":"2019-12-21T12:52:35+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\n|id                                  |created_at              |enabled|price_range|average_ticket|takeout_time|delivery_time|minimum_order_value|merchant_zip_code|merchant_city |merchant_state|merchant_country|dt_proc   |dt        |\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\n|02c94103-61f3-4906-a4a9-55611db9f28c|2017-01-23T12:52:30.910Z|false  |3          |60.0          |0           |50           |30.0               |14025            |RIBEIRAO PRETO|SP            |BR              |2019-12-21|2017-01-23|\n|15e7f5fd-090d-47b9-9f14-b6f7fce3c95d|2017-01-20T13:14:48.286Z|true   |3          |60.0          |0           |0            |30.0               |50180            |SAO PAULO     |SP            |BR              |2019-12-21|2017-01-20|\n|33ca5d3d-b99f-404d-84d9-8df8f38a2261|2017-01-23T12:46:33.457Z|true   |5          |100.0         |0           |45           |10.0               |23090            |RIO DE JANEIRO|RJ            |BR              |2019-12-21|2017-01-23|\n|4927035f-a343-4a65-a9be-945818e2efff|2017-01-20T13:15:04.806Z|true   |3          |80.0          |0           |0            |18.9               |40255            |SALVADOR      |BA            |BR              |2019-12-21|2017-01-20|\n|52feaad8-4961-4afc-8d60-3f29ffd0a7a7|2017-01-20T13:14:27.701Z|true   |3          |60.0          |0           |0            |25.0               |64600            |BARUERI       |SP            |BR              |2019-12-21|2017-01-20|\n+------------------------------------+------------------------+-------+-----------+--------------+------------+-------------+-------------------+-----------------+--------------+--------------+----------------+----------+----------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1576932747595_652689309","id":"20191221-125227_830449066","dateCreated":"2019-12-21T12:52:27+0000","dateStarted":"2019-12-21T12:52:35+0000","dateFinished":"2019-12-21T12:52:35+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:180"},{"title":"Validação","text":"%pyspark\n\n# Leitura da base final\nrawDF_ = spark.read.parquet(destino_raw + \"/*/*.parquet\")\n\n# Validação Volumétrica\nprint(\"> Volumetria de saída equivale-se a de entrada ? --> {}\".format(pousoDF.count() == rawDF_.count()))\n\n# Validação do Schema\nschema = pousoDF.schema\nschema_ = rawDF_.drop(\"dt_proc\").schema\ncolunas = pousoDF.columns\ncolunas_ = rawDF_.drop(\"dt_proc\").columns\ncolunas.sort()\ncolunas_.sort()\nprint(\"> O schema de saída equivale-se ao de entrada ? ---> {}\".format(schema == schema_ or colunas == colunas_))","user":"anonymous","dateUpdated":"2019-12-21T16:08:50+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"> Volumetria de saída equivale-se a de entrada ? --> True\n> O schema de saída equivale-se ao de entrada ? ---> True\n"}]},"apps":[],"jobName":"paragraph_1576932682084_-772707971","id":"20191221-125122_890996710","dateCreated":"2019-12-21T12:51:22+0000","dateStarted":"2019-12-21T16:08:50+0000","dateFinished":"2019-12-21T16:08:51+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:181"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2019-12-21T12:53:36+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1576932816283_-1056236723","id":"20191221-125336_502681573","dateCreated":"2019-12-21T12:53:36+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:182"}],"name":"ifood-landing-restaurant-dev","id":"2EV2DPQUN","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}